name: Update Helium

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Install Nix
        uses: cachix/install-nix-action@v31.9.0
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Update version and hashes
        id: update-check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          UPDATE_NEEDED=false

          # 1. Linux Update Check
          echo "Checking for Linux updates..."
          LATEST_LINUX_VERSION=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/imputnet/helium-linux/releases/latest | jq -r .tag_name)
          CURRENT_LINUX_VERSION=$(nix eval --raw .#packages.x86_64-linux.helium.version)

          if [ "$LATEST_LINUX_VERSION" != "$CURRENT_LINUX_VERSION" ]; then
            echo "Updating Linux from $CURRENT_LINUX_VERSION to $LATEST_LINUX_VERSION"
            sed -i "/linux = \"/ s/linux = \"$CURRENT_LINUX_VERSION\"/linux = \"$LATEST_LINUX_VERSION\"/" flake.nix
            
            X86_URL="https://github.com/imputnet/helium-linux/releases/download/${LATEST_LINUX_VERSION}/helium-${LATEST_LINUX_VERSION}-x86_64_linux.tar.xz"
            ARM_URL="https://github.com/imputnet/helium-linux/releases/download/${LATEST_LINUX_VERSION}/helium-${LATEST_LINUX_VERSION}-arm64_linux.tar.xz"
            
            echo "Fetching Linux hashes..."
            X86_HASH=$(nix hash convert --to sri --hash-algo sha256 $(nix-prefetch-url "$X86_URL"))
            ARM_HASH=$(nix hash convert --to sri --hash-algo sha256 $(nix-prefetch-url "$ARM_URL"))
            
            sed -i "/x86_64-linux = {/,/hash =/ s|hash = \"[^\"]*\"|hash = \"$X86_HASH\"|" flake.nix
            sed -i "/aarch64-linux = {/,/hash =/ s|hash = \"[^\"]*\"|hash = \"$ARM_HASH\"|" flake.nix
            UPDATE_NEEDED=true
          else
            echo "Linux is already at the latest version: $LATEST_LINUX_VERSION"
          fi

          # 2. macOS Update Check
          echo "Checking for macOS updates..."
          LATEST_DARWIN_VERSION=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/imputnet/helium-macos/releases/latest | jq -r .tag_name)
          CURRENT_DARWIN_VERSION=$(nix eval --raw .#packages.x86_64-darwin.helium.version)

          if [ "$LATEST_DARWIN_VERSION" != "$CURRENT_DARWIN_VERSION" ]; then
            echo "Updating macOS from $CURRENT_DARWIN_VERSION to $LATEST_DARWIN_VERSION"
            sed -i "/darwin = \"/ s/darwin = \"$CURRENT_DARWIN_VERSION\"/darwin = \"$LATEST_DARWIN_VERSION\"/" flake.nix
            
            X86_DARWIN_URL="https://github.com/imputnet/helium-macos/releases/download/${LATEST_DARWIN_VERSION}/helium_${LATEST_DARWIN_VERSION}_x86_64-macos.dmg"
            ARM_DARWIN_URL="https://github.com/imputnet/helium-macos/releases/download/${LATEST_DARWIN_VERSION}/helium_${LATEST_DARWIN_VERSION}_arm64-macos.dmg"
            
            echo "Fetching macOS hashes..."
            X86_DARWIN_HASH=$(nix hash convert --to sri --hash-algo sha256 $(nix-prefetch-url "$X86_DARWIN_URL"))
            ARM_DARWIN_HASH=$(nix hash convert --to sri --hash-algo sha256 $(nix-prefetch-url "$ARM_DARWIN_URL"))
            
            sed -i "/x86_64-darwin = {/,/hash =/ s|hash = \"[^\"]*\"|hash = \"$X86_DARWIN_HASH\"|" flake.nix
            sed -i "/aarch64-darwin = {/,/hash =/ s|hash = \"[^\"]*\"|hash = \"$ARM_DARWIN_HASH\"|" flake.nix
            UPDATE_NEEDED=true
          else
            echo "macOS is already at the latest version: $LATEST_DARWIN_VERSION"
          fi

          echo "update_needed=$UPDATE_NEEDED" >> $GITHUB_OUTPUT

      - name: Update flake inputs
        if: steps.update-check.outputs.update_needed == 'true'
        run: nix flake update

      - name: Verify flake
        if: steps.update-check.outputs.update_needed == 'true'
        run: nix flake check --all-systems

      - name: Check for changes
        if: steps.update-check.outputs.update_needed == 'true'
        id: git-check
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.update-check.outputs.update_needed == 'true' && steps.git-check.outputs.changed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add flake.nix flake.lock
          LINUX_V=$(nix eval --raw .#packages.x86_64-linux.helium.version)
          DARWIN_V=$(nix eval --raw .#packages.x86_64-darwin.helium.version)
          git commit -m "chore: update helium (linux: $LINUX_V, macos: $DARWIN_V) and update flake.lock"
          git push
